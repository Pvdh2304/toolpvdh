<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Generator</title>
</head>
<body>

<?php
// Set timezone to Asia/Ho_Chi_Minh (GMT+7)
date_default_timezone_set('Asia/Ho_Chi_Minh');

// Get the user's IP address
$ip_address = $_SERVER['REMOTE_ADDR'];

// Generate a unique key for each IP that resets daily
function generateKey($ip_address) {
    $date = date('Y-m-d'); // Current date
    $unique_part = substr(md5($ip_address . $date), 0, 10); // 10-char unique part
    return "Pvdh" . $unique_part;
}

// File to store keys
$json_file = 'keys.json';

// Load existing keys from the JSON file
$keys = [];
if (file_exists($json_file)) {
    $keys = json_decode(file_get_contents($json_file), true);
}

// Generate a new key if it doesn't exist or the day has changed
$key = generateKey($ip_address);
if (!isset($keys[$ip_address]) || $keys[$ip_address]['date'] !== date('Y-m-d')) {
    $keys[$ip_address] = ['key' => $key, 'date' => date('Y-m-d')];
    
    // Save the updated keys to the JSON file
    file_put_contents($json_file, json_encode($keys));
} else {
    $key = $keys[$ip_address]['key'];
}

// Prepare the API URL with the generated key
$long_url = urlencode('https://pvdh.top/key?key=' . $key);
$api_token = '6513ea0e5fff14347929b322';
$api_url = "https://link4m.co/api-shorten/v2?api={$api_token}&url={$long_url}";

// Perform the API request
$result = @json_decode(file_get_contents($api_url), true);
?>

    <h1>Generated Key</h1>
    <p>Your unique key for today is: <strong><?php echo $key; ?></strong></p>

    <?php if ($result["status"] !== 'success'): ?>
        <p>Error: <?php echo $result["message"]; ?></p>
    <?php else: ?>
        <p>Shortened URL: <a href="<?php echo $result["shortenedUrl"]; ?>" target="_blank"><?php echo $result["shortenedUrl"]; ?></a></p>
    <?php endif; ?>

</body>
</html>
